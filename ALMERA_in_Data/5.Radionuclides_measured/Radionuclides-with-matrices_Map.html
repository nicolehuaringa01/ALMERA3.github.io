<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/ALMERA3.github.io/favicon.ico" type="image/x-icon">
  <title>ALMERA Radionuclides Map</title>
  <!-- Load D3 and TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Inter", sans-serif; background-color: #f7fafc; }
    #chart-container {
      position: relative; max-width: 900px; margin: 20px auto; border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); background-color: #fff;
      overflow: hidden; padding: 1rem; display: flex; flex-direction: column; align-items: center;
    }
    canvas { display: block; width: 100%; height: auto; background-color: #e2e8f0; border-radius: 0.5rem; }
    #tooltip {
      position: absolute; padding: 8px; background: rgba(0,0,0,0.7); color: white;
      border-radius: 4px; pointer-events: none; font-size: 12px; display: none;
    }
  </style>
</head>
<body>
  <div id="chart-container" class="space-y-4">
    <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">Interactive ALMERA Laboratories</h1>
    <input type="text" id="search-bar" placeholder="Search..." class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
    <div id="map-container" class="relative w-full aspect-[2/1] bg-gray-200 rounded-lg overflow-hidden">
      <canvas id="map-canvas" class="w-full h-full"></canvas>
      <div id="tooltip" class="absolute z-10"></div>
    </div>
  </div>

  <script>
  async function initializeRadionuclidesChart() {
    const container = document.getElementById("chart-container");
    const canvas = document.getElementById("map-canvas");
    const context = canvas.getContext("2d");
    const tooltip = document.getElementById("tooltip");
    const searchBar = document.getElementById("search-bar");

    let width = container.clientWidth;
    let height = width / 2;
    canvas.width = width;
    canvas.height = height;

    // --- Load Data ---
    const [world, dataRaw] = await Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json"),
      d3.csv("/ALMERA3.github.io/data/2020_ALMERA_Capabilities_Survey.csv")
    ]);
    let data = dataRaw;
    let filteredData = [...data];
    let selectedPoint = null;

    const land = topojson.feature(world, world.objects.countries);

    let projection = d3.geoEqualEarth().fitSize([width, height], land);
    let path = d3.geoPath(projection, context);

    const colorScale = d3.scaleOrdinal()
      .domain(["EUROPE", "NORTH AND LATIN AMERICA", "ASIA PACIFIC", "AFRICA", "MIDDLE EAST"])
      .range(["#d9534f", "#428bca", "#5cb85c", "#f0ad4e", "#5bc0de"]);

    // --- Clustering function ---
    function clusterPoints(points, radius) {
      const clusters = [];
      points.forEach(p => {
        let cluster = clusters.find(c => {
          const dx = c.x - p.x, dy = c.y - p.y;
          return Math.sqrt(dx*dx + dy*dy) < radius;
        });
        if (cluster) {
          cluster.points.push(p);
        } else {
          clusters.push({ x: p.x, y: p.y, points: [p] });
        }
      });
      return clusters;
    }

    // --- Render function ---
    function render() {
      context.clearRect(0, 0, canvas.width, canvas.height);

      // Draw land
      context.beginPath();
      path(land);
      context.fillStyle = "#79acd2";
      context.fill();

      // Map data → points
      const points = filteredData.map(d => {
        const coords = projection([+d.Longitude || +d.Long, +d.Latitude || +d.Lat]);
        if (!coords) return null;
        const [x, y] = coords;
        return {
          x, y,
          color: colorScale(d["1.4 Geographic Region"] || "Other"),
          info: d["1.1 Name of Laboratory"] || "Unknown",
          city: d["City"] || "Unknown City",
          memberState: d["1.3 Member State"] || "Unknown State",
          contact: d["1.7 Contact Person"] || "No contact",
          email: d["1.8 Contact Person E-mail"] || "No email",
          address: d["1.2 Physical Address"] || "No address",
          radionuclides: d["5.2 Radionuclides measured by laboratory"] || "No data"
        };
      }).filter(Boolean);

      // Cluster
      const clusters = clusterPoints(points, 15);

      clusters.forEach(c => {
        if (c.points.length > 1) {
          context.beginPath();
          context.arc(c.x, c.y, 10, 0, 2 * Math.PI);
          context.fillStyle = "gray";
          context.fill();
          context.fillStyle = "white";
          context.textAlign = "center";
          context.textBaseline = "middle";
          context.font = "12px Arial";
          context.fillText(c.points.length, c.x, c.y);
        } else {
          const p = c.points[0];
          context.beginPath();
          context.arc(p.x, p.y, 5, 0, 2 * Math.PI);
          context.fillStyle = p.color;
          context.fill();
        }
      });

      return points;
    }

    let renderedPoints = render();

    // --- Search ---
    searchBar.addEventListener("input", function() {
      const q = this.value.toLowerCase();
      filteredData = data.filter(d =>
        (d["1.3 Member State"] && d["1.3 Member State"].toLowerCase().includes(q)) ||
        (d["1.1 Name of Laboratory"] && d["1.1 Name of Laboratory"].toLowerCase().includes(q)) ||
        (d["1.4 Geographic Region"] && d["1.4 Geographic Region"].toLowerCase().includes(q)) ||
        (d["1.7 Contact Person"] && d["1.7 Contact Person"].toLowerCase().includes(q)) ||
        (d["City"] && d["City"].toLowerCase().includes(q)) ||
        (d["5.2 Radionuclides measured by laboratory"] && d["5.2 Radionuclides measured by laboratory"].toLowerCase().includes(q))
      );
      renderedPoints = render();
    });

    // --- Tooltips ---
    canvas.addEventListener("mousemove", (event) => {
      if (selectedPoint) return;
      const rect = canvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left, mouseY = event.clientY - rect.top;
      const hovered = renderedPoints.find(p => {
        const dx = mouseX - p.x, dy = mouseY - p.y;
        return Math.sqrt(dx*dx + dy*dy) <= 5;
      });
      if (hovered) {
        tooltip.style.display = "block";
        tooltip.style.left = `${event.pageX + 10}px`;
        tooltip.style.top = `${event.pageY + 10}px`;
        tooltip.innerHTML = `
          <strong>${hovered.info}</strong><br>
          🏢 ${hovered.address}<br>
          📍 ${hovered.city}<br>
          🌍 ${hovered.memberState}<br>
          <hr class="my-1 border-gray-600">
          🧑‍💼 ${hovered.contact}<br>
          📧 ${hovered.email}<br>
          <hr class="my-1 border-gray-600">
          <span class="font-semibold">Radionuclides:</span><br>
          ${hovered.radionuclides.split(';').join('<br>')}
        `;
      } else {
        tooltip.style.display = "none";
      }
    });

    canvas.addEventListener("click", (event) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left, mouseY = event.clientY - rect.top;
      const clicked = renderedPoints.find(p => {
        const dx = mouseX - p.x, dy = mouseY - p.y;
        return Math.sqrt(dx*dx + dy*dy) <= 5;
      });
      if (clicked) {
        selectedPoint = clicked;
      } else {
        selectedPoint = null;
        tooltip.style.display = "none";
      }
    });

    // --- Responsiveness ---
    window.addEventListener("resize", () => {
      width = container.clientWidth;
      height = width / 2;
      canvas.width = width;
      canvas.height = height;
      projection.fitSize([width, height], land);
      path = d3.geoPath(projection, context);
      renderedPoints = render();
    });

    // --- Zoom ---
    const zoom = d3.zoom()
      .scaleExtent([1, 250])
      .on("zoom", (event) => {
        const t = event.transform;
        projection.translate([t.x, t.y]).scale(t.k * (canvas.width / 2 / Math.PI));
        renderedPoints = render();
      });

    d3.select(canvas).call(zoom).on("dblclick.zoom", null);
  }

  document.addEventListener("DOMContentLoaded", initializeRadionuclidesChart);
  </script>
</body>
</html>
